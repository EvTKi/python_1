# Генерация XML из CSV с Role-Privilige-DataGroup-ObjectReference

## Описание

Данное приложение автоматически преобразует CSV-файлы с перечнем ролей (и связанных с ними данных) в RDF/XML-файлы с заданной структурой. Весь процесс легко контролируется через удобный графический интерфейс.

Реализованы:
- Поддержка любых кодировок входных файлов (определяется автоматически)
- Проверка целостности и логирование ошибок
- Графический интерфейс на Tkinter: выбор папки, файлов и просмотр лога
- Гибкая архитектура: скрипт можно вызывать как из Python-кода, так и из командной строки

---



## Установка

1. **Python 3.6+** должен быть установлен в системе.
2. Установите необходимые библиотеки:
`pip install lxml chardet`

---
## Ключевые возможности

- **Пакетная обработка**: автоматически обрабатывает все `.csv` (за исключением `Sample.csv`) в рабочей директории
- **Отдельный результат для каждого исходного файла**: XML и лог на каждый CSV
- **Безопасная обработка**: ошибка одной строки или даже файла не прерывает общий цикл
- **Детализированное логирование**: каждый шаг, ошибка, отслеживается в своем лог-файле (формат log/[имя-CSV].log)
- **Автоматическое создание лог-папки**
- **CIM-структурирование**: для каждой строки формируются CIM-объекты: Role, Privilege, DataGroup, ObjectReference
- **Гибкость**: легко адаптировать под специфику данных и CIM-классов

---

## Сценарии применения

- Автоматизация наполнения справочной модели доступа (RBAC) по каталогам подразделений
- Быстрая массовая миграция из табличных данных в стандартизированный XML (IEC CIM)
- Подготовка файлов для загрузки в системы управления/интеграционные платформы Monitel, SCADA, EMS и другие решения

## Формат исходного CSV
Обязательные поля и их назначение:

| Поле             | Формат данных | Описание                       | Пример                               |
| ---------------- | ------------- | ------------------------------ | ------------------------------------ |
| dep_uid          | GUID          | UID подразделения (objectUid)  | fc7f76ef-e381-4659-82f6-2e7a5ba097b8 |
| dep_name         | Str           | Наименование подразделения     | Бухгалтерия                          |
| dep_headdep_uid  | GUID          | UID вышестоящего подразделения | ... (может быть пустым)              |
| dep_headdep_name | Str           | Имя вышестоящего департамента  | ... (может быть пустым)              |
| org_uid          | GUID          | UID организации                | gc7f76ef-e381-4659-82f6-2e7a5ba097b8 |
| org_name         | Str           | Наименование организации       | Организация_1                        |
---


## Запуск через UI

1. Запустите файл `ui.py` (двойной клик или через командную строку):
`python ui.py`

2. В появившемся окне:
- Введите UID папки для ролей (его предоставляет ваша система, либо служба безопасности)
- Выберите папку с CSV-файлами (кнопка «Выбрать...»)
- Отметьте/снимите чекбоксы у файлов для обработки
- Нажмите «Старт» — результаты конвертации и ошибки будут видны в протоколе
- Для перехода к папке результатов используйте кнопку «Открыть папку с результатами»

---

## Запуск через командную строку

Вы можете использовать `main.py` как утилиту:
`python main.py <UID_папки> <путь_к_папке_с_csv>`



---

## Жизненный цикл обработки

1. **Поиск файлов**  
   Все файлы вида `*.csv`, кроме `Sample.csv`, собираются для обработки.

2. **Запрос у пользователя UID папки для ролей**  
   UID вводится один раз и будет использован как CIM-ParentObject для всех ролей из всех файлов.

3. **Построчная обработка каждого файла**  
    - Для каждой строки берутся значения `org_name`, `dep_name`, `dep_uid`.
    - Генерируются уникальные идентификаторы CIM-объектов (Role, Privilege, DataGroup, ObjectReference).
    - Строится RDF/XML-цепочка объектов согласно требованиям CIM.
    - Все события, ошибки, успешные операции отражаются в отдельном логе.

4. **Формирование выходных файлов**  
    - Для каждого исходника создаётся отдельный `.xml` (например, `mycompany.csv` → `mycompany.xml`).
    - Лог сохраняется по маршруту `log/mycompany.log`.

## Структура выходных файлов

- Для каждого `.csv` (кроме `Sample.csv`) — свой XML (например: `dep_org.csv` → `dep_org.xml`)
- Каждый входной файл сопровождается своим логом (например: `dep_org.csv` → `log/dep_org.log`)
- Все логи — в папке `log/`, создаётся автоматически

---

### Пример содержимого log-файла
[2025-08-05 17:27:01] INFO: Старт обработки файла dep_org.csv → dep_org.xml
[2025-08-05 17:27:01] INFO: Строка 2: Добавляется роль: Организация_1\Отдел_1, dep_uid=fc7f76ef-e381-4659-82f6-2e7a5ba097b8
[2025-08-05 17:27:01] ERROR: Ошибка при обработке строки 3 в dep_org.csv: KeyError: 'org_name'
[2025-08-05 17:27:01] INFO: Завершена обработка файла. Всего добавлено ролей: 1. XML сохранён: dep_org.xml

---


## Частые вопросы

- **Кодировка CSV не utf-8?**
  - Программа определяет кодировку автоматически.
  - Если возникают проблемы — проверьте, чтобы ваши файлы имели структуру, как в примере выше.

- **Где посмотреть результат?**
  - В папке выбранной для обработки — там будут файлы `.xml` с теми же именами.

- **Что делать, если появляются ошибки в логе?**
  - Проверьте правильность и полноту заголовков и данных в csv-файле.

---

### Пример необходимости лога
Лог позволяет оперативно выявить:
ошибки структурирования и заполнения CSV-файла (например, отсутствует колонка, неправильное имя поля)
ошибки при записи или формировании XML
успешные действия (количество добавленных ролей по каждому файлу)

### Расширяемость
Для поддержки других CIM-сущностей — добавьте обработку доп. столбцов в CSV и блоки генерации в цикл обработки строк.
Для интеграции с БД или веб-API — используйте модуль csv и lxml с небольшими модификациями.

## Важно
Название Sample.csv не должно использоваться для рабочих данных — его скрипт игнорирует всегда.
Если у вас нет нужной колонки в CSV — корректность структуры лога гарантирует поиск и исправление ошибок на этапе загрузки.

## Рекомендации по качеству исходных CSV
Используйте ; в качестве разделителя.
Не допускайте дублирования ролей (строки с одинаковыми dep_uid, dep_name, org_name).
Держите первую строку — шапку — в актуальном и полном виде.
Не оставляйте пустых обязательных полей: org_name, dep_name, dep_uid.
В случае больших файлов разбивайте их на части для удобства анализа логов.

---

## Требования

- Python >= 3.6
- Установленные модули: `lxml`, `chardet`
- Корректно заполненные CSV-файлы (см. выше)
