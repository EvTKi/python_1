# CIM Roles and Privileges XML Batch Generator

## Описание

Этот Python-скрипт предназначен для **массового преобразования справочников подразделений** в формате CSV в CIM/RDF XML-структуру для ролей, привилегий и групп данных (соответствующих IEC CIM и требованиям Monitel Access Control). Для каждого исходного файла формируется отдельный XML, а процесс работы (в том числе все ошибки) досконально отражается в логах, размещаемых в папке `log/`.

---

## Ключевые возможности

- **Пакетная обработка**: автоматически обрабатывает все `.csv` (за исключением `Sample.csv`) в рабочей директории
- **Отдельный результат для каждого исходного файла**: XML и лог на каждый CSV
- **Безопасная обработка**: ошибка одной строки или даже файла не прерывает общий цикл
- **Детализированное логирование**: каждый шаг, ошибка, отслеживается в своем лог-файле (формат log/[имя-CSV].log)
- **Автоматическое создание лог-папки**
- **CIM-структурирование**: для каждой строки формируются CIM-объекты: Role, Privilege, DataGroup, ObjectReference
- **Гибкость**: легко адаптировать под специфику данных и CIM-классов

---

## Сценарии применения

- Автоматизация наполнения справочной модели доступа (RBAC) по каталогам подразделений
- Быстрая массовая миграция из табличных данных в стандартизированный XML (IEC CIM)
- Подготовка файлов для загрузки в системы управления/интеграционные платформы Monitel, SCADA, EMS и другие решения

---

## Требования

- Python 3.7+
- lxml (`pip install lxml`)

---

## Формат исходного CSV

Обязательные поля и их назначение:

| Поле                  | Описание                            | Пример                                    |
|-----------------------|-------------------------------------|--------------------------------------------|
| dep_uid               | UID подразделения (objectUid)       | fc7f76ef-e381-4659-82f6-2e7a5ba097b8       |
| dep_name              | Наименование подразделения          | Бухгалтерия                                |
| dep_headdep_uid       | UID руководителя подразделения      | ... (может быть пустым)                    |
| dep_headdep_name      | Имя руководителя департамента       | ... (может быть пустым)                    |
| org_uid               | UID организации                     | ...                                        |
| org_name              | Наименование организации            | Организация_1                              |

**Пример строки:**
fc7f76ef-e381-4659-82f6-2e7a5ba097b8;Отдел_1;123;Руководитель;768a-09;Организация_1

- Все поля, кроме `dep_uid`, `dep_name`, `org_name`, используются только для информативности или, при необходимости, расширения генератора.

---

## Структура выходных файлов

- Для каждого `.csv` (кроме Sample.csv) — свой XML (**например:** `dep_org.csv` → `dep_org.xml`)
- Каждый входной файл сопровождается своим логом (**например:** `dep_org.csv` → `log/dep_org.log`)
- Все логи — в папке `log/`, создаётся автоматически

### Пример содержимого log-файла
[2025-08-05 17:27:01] INFO: Старт обработки файла dep_org.csv → dep_org.xml
[2025-08-05 17:27:01] INFO: Строка 2: Добавляется роль: Организация_1\Отдел_1, dep_uid=fc7f76ef-e381-4659-82f6-2e7a5ba097b8
[2025-08-05 17:27:01] ERROR: Ошибка при обработке строки 3 в dep_org.csv: KeyError: 'org_name'
[2025-08-05 17:27:01] INFO: Завершена обработка файла. Всего добавлено ролей: 1. XML сохранён: dep_org.xml

---

## Жизненный цикл обработки

1. **Поиск файлов**  
   Все файлы вида `*.csv`, кроме `Sample.csv`, собираются для обработки.

2. **Запрос у пользователя UID папки для ролей**  
   UID вводится один раз и будет использован как CIM-ParentObject для всех ролей из всех файлов.

3. **Построчная обработка каждого файла**  
    - Для каждой строки берутся значения `org_name`, `dep_name`, `dep_uid`.
    - Генерируются уникальные идентификаторы CIM-объектов (Role, Privilege, DataGroup, ObjectReference).
    - Строится RDF/XML-цепочка объектов согласно требованиям CIM.
    - Все события, ошибки, успешные операции отражаются в отдельном логе.

4. **Формирование выходных файлов**  
    - Для каждого исходника создаётся отдельный `.xml` (например, `mycompany.csv` → `mycompany.xml`).
    - Лог сохраняется по маршруту `log/mycompany.log`.

---

## Пример запуска

```sh
python csv2cim.py
Введите UID папки для ролей: d0abf8f8-d3ef-4c79-8812-123456789abc
Готово! dep_org.xml сформирован из dep_org.csv. Лог: log/dep_org.log

Пример структуры каталога
/
├── dep_org.csv
├── hr_departments.csv
├── csv2cim.py
├── dep_org.xml
├── hr_departments.xml
└── log/
    ├── dep_org.log
    └── hr_departments.log

Пример необходимости лога
Лог позволяет оперативно выявить:
ошибки структурирования и заполнения CSV-файла (например, отсутствует колонка, неправильное имя поля)
ошибки при записи или формировании XML
успешные действия (количество добавленных ролей по каждому файлу)

Расширяемость
Для поддержки других CIM-сущностей — добавьте обработку доп. столбцов в CSV и блоки генерации в цикл обработки строк.
Для интеграции с БД или веб-API — используйте модуль csv и lxml с небольшими модификациями.

Важно
Все входные CSV-файлы должны быть в кодировке UTF-8 и иметь шапку (имена колонок на первой строке)
Название Sample.csv не должно использоваться для рабочих данных — его скрипт игнорирует всегда.
Если у вас нет нужной колонки в CSV — корректность структуры лога гарантирует поиск и исправление ошибок на этапе загрузки.

Рекомендации по качеству исходных CSV
Используйте ; в качестве разделителя.
Не допускайте дублирования ролей (строки с одинаковыми dep_uid, dep_name, org_name).
Держите первую строку — шапку — в актуальном и полном виде.
Не оставляйте пустых обязательных полей: org_name, dep_name, dep_uid.
В случае больших файлов разбивайте их на части для удобства анализа логов.
