# Генерация XML из CSV с Role-Privilege-DataGroup-ObjectReference

## Описание

Это приложение автоматически преобразует CSV-файлы со структурой отделов и организаций в RDF/XML-файлы в соответствии с CIM-схемой (Role-Privilege-DataGroup-ObjectReference). Для каждого исходного файла формируется свой XML и детальный лог операций. Присутствует графический интерфейс (Tkinter) и поддержка пакетной обработки через командную строку. Все этапы строго логируются: логи складываются в папку `log` и именуются по маске `[имя-файла]_[дата].log`.

---

## Установка

1. Установите Python 3.6+.
2. Установите необходимые библиотеки:
```pip install lxml chardet```

---

## Формат исходного CSV

Каждый CSV-файл должен иметь следующую структуру (разделитель — точка с запятой):

| Поле             | Формат данных | Описание                         | Пример                                 |
|------------------|--------------|-----------------------------------|----------------------------------------|
| dep_uid          | GUID         | UID подразделения                 | fc7f76ef-e381-4659-82f6-2e7a5ba097b8   |
| dep_name         | Строка       | Наименование подразделения        | Бухгалтерия                            |
| dep_headdep_uid  | GUID         | UID headdep подразделения (или "")| 8383B7DD-AAAD-4F10-ADEF-D50FD7974D9D   |
| org_uid          | GUID         | UID организации                   | 768a-09                                |
| org_name         | Строка       | Наименование организации          | Организация_1                          |

---

## Ключевые возможности

- **Пакетная обработка**: автоматически ищет и обрабатывает все `.csv` (кроме `Sample.csv`) в указанной папке.
- **XML и лог на каждый CSV**: выходные `xml` файлы и логи кладутся рядом с исходниками; логи в папку `log` и именуются `[имяcsv]_[дата].log`.
- **Лог строгого формата**:  
`[YYYY-MM-DD HH:MM:SS] INFO/ERROR: Описание события/ошибки`
- **Безопасность цикла**: ошибка одной строки или файла не блокирует обработку остальных файлов.
- **Графический интерфейс**: выбор папки, файлов и просмотр лога.
- **Автоматическое создание папки log** (рядом с обрабатываемыми файлами).
- **Гибкое расширение**: структура CIM легко модифицируется в коде.
- **Csv-файл Sample.csv** всегда исключается из обработки.

---

## Запуск через UI

1. Запустите `ui.py`:
 ```sh
 python ui.py
 ```
2. В окне:
- Введите UID папки для ролей (его выдает ваша система или служба ИБ)
- Выберите папку с CSV-файлами (кнопка «Выбрать...»)
- Отметьте нужные файлы для обработки
- Нажмите «Старт» — логи и статус появятся сразу в окне
- Для открытия папки с результатами нажмите «Открыть папку»

---

## Запуск через командную строку

```sh 
python main.py <UID_Папки> <путь_к_папке_с_CSV>
```

Например: ```python main.py 123e4567-e89b-12d3-a456-426614174000 ./csv_data```

---
## Жизненный цикл обработки
1. Поиск файлов:
  Все файлы `*.csv` (кроме `Sample.csv`) в выбранной папке добавляются в очередь.
2. Ввод UID папки для ролей:
  UID указывается один раз для всего процесса.
3. Построчная обработка:
* Для каждой строки CSV создаётся CIM-структура (Role-Privilege-DataGroup-ObjectReference).
* Для департаментов-headdep формируется роль с правом на свой и все подчинённые отделы, для остальных — только для себя.
* Любые ошибки заносятся в лог (и не мешают остальным строкам и файлам).
4. Результаты:
* Каждый CSV преобразуется в свой .xml (например, corp.csv → corp.xml).
* Лог лежит в подкаталоге log по маске log/corp_YYYY-MM-DD.log, где YYYY-MM-DD — текущая дата.

---
## Пример лога
```
[2025-08-05 17:27:01] INFO: Старт обработки файла dep_org.csv → dep_org.xml
[2025-08-05 17:27:01] INFO: Строка 2: Добавляется роль: Организация_1\Бухгалтерия, dep_uid=fc7f76ef-e381-4659-82f6-2e7a5ba097b8
[2025-08-05 17:27:01] ERROR: Ошибка при обработке строки 3 в dep_org.csv: KeyError: 'org_name'
[2025-08-05 17:27:01] INFO: Завершена обработка файла. Всего добавлено ролей: 1. XML сохранён: dep_org.xml
```

---
## Качество входных CSV

* Разделитель обязательно — ;
* Не допускайте дублирования строк по dep_uid, dep_name, org_name
* В первой строке (шапке) должны быть все обязательные столбцы
* Не оставляйте пустых обязательных полей: org_name, dep_name, dep_uid
* Если файлы большие — рекомендуем делить на части для контроля логов

---

## Частые вопросы

* Кодировка CSV может быть любой?
  Да, программа определяет её автоматически.

* Где искать результаты?
  В выбранной для обработки папке появятся файлы .xml, логи — в подкаталоге log.

* Что делать при ошибках?
  Проверьте структуру/имена колонок, читаемость файлов; все детали есть в логе.

* Почему игнорируется Sample.csv?
  Это пример, он никогда не обрабатывается автоматически.

## Требования

* Python >= 3.6

* Библиотеки: lxml, chardet

* Структурированные, валидные CSV (см. выше)

## Расширяемость

* Для новых CIM-сущностей и связей — добавьте обработку нужных полей и XML-блоков в main.py.

* Для интеграции с REST/API, БД — замените блоки чтения/выгрузки по вашему сценарию.
